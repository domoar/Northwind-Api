name: Generate Code Coverage

permissions:
  contents: read

on:
  workflow_run:
    workflows: ["CI - Build, Format, Test"]
    types:
      - completed

jobs:
  generate-coverage:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code at the triggering commit
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.workflow_run.head_repository.full_name }}
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore tools
        run: dotnet tool restore

      - name: Run Unit Tests with Coverage
        run: |
          dotnet test ./tests/UnitTests/UnitTests.csproj \
            --collect:"XPlat Code Coverage" \
            --results-directory ./coverage-results/unittests

      - name: Run Integration Tests with Coverage
        run: |
          dotnet test ./tests/IntegrationTests/IntegrationTests.csproj \
            --collect:"XPlat Code Coverage" \
            --results-directory ./coverage-results/integrationtests

      - name: Merge coverage reports
        run: |
          dotnet reportgenerator \
            "-reports:coverage-results/**/coverage.cobertura.xml" \
            "-targetdir:coverage-report" \
            "-reporttypes:Html"

      - name: Upload Coverage Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-report
